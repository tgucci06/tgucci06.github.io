---
title: "æ•™å¸«ã‚ã‚Šå­¦ç¿’ èª²é¡Œ"
author: "è°·å£å‹å“‰"
ddate: "`r format(Sys.time(), '%Y/%m/%d')`"
output:
  rmdformats::downcute:
    code_folding: hide
    self_contained: TRUE
    thumbnails: FALSE
    lightbox: FALSE
    css: style.css
    md_extensions: -ascii_identifiers
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# èª²é¡Œ2  

R ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ "MASS"ã® "Boston" ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«å¯¾ã—ã¦ï¼Œå¤‰æ•° medv ã‚’ç›®çš„å¤‰æ•°ï¼Œãã‚Œä»¥å¤–ã‚’èª¬æ˜å¤‰æ•°ã¨ã—ã¦ lasso ã‚’é©ç”¨ã—ï¼Œè§£ãƒ‘ã‚¹å›³ãŠã‚ˆã³ CV ã®æ¨ç§»ã®å›³ï¼Œ CV ã«ã‚ˆã£ã¦é¸æŠã•ã‚ŒãŸå›å¸°ä¿‚æ•°ã‚’å‡ºåŠ›ã›ã‚ˆ

```{r,include = FALSE}
library(MASS)
```
```{r}
data(Boston)
head(Boston)
```


* glmnetUtils ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ ã‚’ä½¿ã†ã“ã¨ã§ formula ãƒãƒƒã‚¯ (y ~ x) ã§æ›¸ã‘ã‚‹
  * https://cran.r-project.org/web/packages/glmnetUtils/vignettes/intro.html

```{r,include = FALSE}
library(glmnet)
library(glmnetUtils)
```

```{r}
par(family= "HiraKakuProN-W3")
fit.Lasso <- glmnet(medv ~ ., data = Boston)
plot(fit.Lasso, xvar="lambda", label=TRUE,
     xlab="æ­£å‰‡åŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¯¾æ•°å€¤", 
     ylab="å›å¸°ä¿‚æ•°", col="black", lwd=2.5)
```

* ggfortify ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã†ã“ã¨ã§ã€ggplot é¢¨ã«æç”»ã§ãã‚‹
  * https://cran.r-project.org/web/packages/ggfortify/vignettes/plot_lm.html

```{r,include = FALSE}
library(ggfortify)
```

```{r}
autoplot(fit.Lasso, xvar = "lambda")
```


* CV

```{r}
fit.Lasso.cv <- cv.glmnet(medv ~ ., data = Boston,
                           nfolds = 10,
                           alpha = 1, 
                           standardize = TRUE)
```

```{r}
par(family= "HiraKakuProN-W3")
# CVå€¤ã®æ¨ç§»ã‚’ãƒ—ãƒ­ãƒƒãƒˆ
plot(fit.Lasso.cv, xlab="æ­£å‰‡åŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¯¾æ•°å€¤", ylab="ï¼’ä¹—èª¤å·®")
```

```{r}
# CVå€¤ãŒæœ€å°ã¨ãªã‚‹æ­£å‰‡åŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤ã‚’å‡ºåŠ›
fit.Lasso.cv$lambda.min
# 1æ¨™æº–èª¤å·®ãƒ«ãƒ¼ãƒ«ã«ã‚ˆã‚Šé¸æŠã•ã‚ŒãŸæ­£å‰‡åŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å€¤ã‚’å‡ºåŠ›
fit.Lasso.cv$lambda.1se
```


```{r,include = FALSE}
library(ggfortify)
```

```{r}
autoplot(fit.Lasso.cv)
```

* broom ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã†ã“ã¨ã§ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’çµæœã‚’ tidy å½¢å¼ã«ã§ãã‚‹
  * http://varianceexplained.org/broom-gallery/snippets/broom-glmnet.html

```{r,include = FALSE}
library(broom)
```

```{r}
tidied_cv <- tidy(fit.Lasso.cv)
head(tidied_cv)
```


* ä¸Šã§æ±‚ã‚ãŸå€¤ã¨ä¸€è‡´ã—ãªã„ã€‚ã€‚ã€‚ãªãœï¼Ÿ
```{r}
glance_cv <- glance(fit.Lasso.cv)
glance_cv
```


* tidy data ã«ã™ã‚‹ã“ã¨ã§ lambda ã¨æ¨å®šå€¤ã®æ¨ç§»ã‚’ ggplot ã§æç”»ã§ãã‚‹

```{r,include = FALSE}
library(ggplot2)
```

```{r}
ggplot(tidied_cv, aes(lambda, estimate)) + 
  geom_line(color = "red") +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2) +
  scale_x_log10() +
  geom_vline(xintercept = glance_cv$lambda.min) +
  geom_vline(xintercept = glance_cv$lambda.1se, lty = 2)
```

* cv ã§é¸æŠã•ã‚ŒãŸ lambda ã‚’å›ºå®š

```{r}
# fit.Lasso.cv$lambda.min ã§æ±‚ã‚ãŸå€¤
fit.Lasso1 <- glmnet(medv ~ ., data = Boston,lambda = 0.02800535)
fit.Lasso1$beta
```


```{r}
# glanceé–¢æ•°ã§å‡ºåŠ›ã•ã‚ŒãŸçµæœ
fit.Lasso2 <- glmnet(medv ~ ., data = Boston,lambda = 0.02325053)
fit.Lasso2$beta
```

* ä¿‚æ•°ã¯å°‘ã—å¤‰ã‚ã‚‹ãŒã€0ã¨æ¨å®šã•ã‚Œã‚‹å¤‰æ•°ã¯åŒã˜

# èª²é¡Œ4

é©å½“ãªãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ fused lasso or L1 ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’é©ç”¨ã—ã€å½“ã¦ã¯ã‚æ›²ç·šã‚’å‡ºåŠ›ã›ã‚ˆï¼ğœ†ã®å€¤ã¯é©å½“ã§ã‚ˆã„  
ã¾ãŸã¯ã€é©å½“ãªãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ã‚°ãƒ©ãƒ•ã‚£ã‚«ãƒ«lassoã‚’é©ç”¨ã—ã€æ¨å®šã•ã‚ŒãŸã‚°ãƒ©ãƒ•ã‚’å‡ºåŠ›ã›ã‚ˆï¼ğœ†ã®å€¤ã¯é©å½“ã§ã‚ˆã„

* genlassoãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®fusedlasso1dã‚’ç”¨ã„ã‚‹ã“ã¨ã§fused lassoã«ã‚ˆã‚‹æ¨å®šã‚’è¡Œãˆã‚‹

```{r,include = FALSE}
library(genlasso)
```

```{r}
set.seed(1)
n = 100
i = 1:n
y = (i > 20 & i < 30) + 5*(i > 50 & i < 70) + rnorm(n, sd=0.1)
out = fusedlasso1d(y)
```


```{r}
plot(out, lambda=1)
```


# èª²é¡Œ6 

R package "grpreg" ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ "Lung" ã«å¯¾ã—ã¦ï¼Œ`å¤‰æ•° Lung$y[,1] ã‚’ ç›®çš„å¤‰æ•°ï¼Œ Lung$X` ã‚’èª¬æ˜å¤‰æ•°ã¨ã—ã¦ group lasso ã‚’é©ç”¨ã—ï¼Œè§£ãƒ‘ã‚¹å›³ãŠã‚ˆã³å›å¸°ä¿‚æ•°ã‚’å‡ºåŠ›ã›ã‚ˆã€‚ğœ†ã®å€¤ã¯é©å½“ã§ã‚ˆã„

* grpregã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ : https://cran.r-project.org/web/packages/grpreg/grpreg.pdf

* Lungãƒ‡ãƒ¼ã‚¿ : è‚ºãŒã‚“ã«å¯¾ã™ã‚‹2ã¤ã®æ²»ç™‚ãƒ¬ã‚¸ãƒ¡ãƒ³ã®ç„¡ä½œç‚ºåŒ–è©¦é¨“ã®ãƒ‡ãƒ¼ã‚¿

```{r,include = FALSE}
library(grpreg)
```

* ãƒ‡ãƒ¼ã‚¿ã‚’çœºã‚ã¦ã¿ã‚‹

```{r}
data(Lung)
hist(Lung$y[,1], xlab="Follow-up time", main="")
```

```{r}
X <- Lung$X
y <- Lung$y
group <- Lung$group
fit_grlasso <- grpreg(X, y, group, penalty="grLasso",log.lambda = 10.9897)

```

```{r}
plot(fit_grlasso)
```

```{r}
# Plot group norms, with labels in right margin
plot(fit_grlasso, norm=TRUE, label=TRUE)
```

```{r}
# lambda = 10 ã®ã¨ãã®ä¿‚æ•°ã‚’è¡¨ç¤º
coef(fit_grlasso,lambda = 10)# ä¿‚æ•°ã®æ¨å®šå€¤
```





